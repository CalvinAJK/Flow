@model Flow.Models.ChatViewModel;
@{
    ViewData["Title"] = "Chat";
}

<h2>@ViewData["Title"]</h2>
<h3>Organization Chat</h3>

<!-- SignalR scripts -->
<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

<div id="organizationChat">
    <div id="messagesList"></div>
    <input type="text" id="messageInput" />
    <button id="sendButton">Send</button>
</div>

@if (Model.Teams.Any())
{
    <h3>Teams</h3>
    <ul>
        @foreach (var team in Model.Teams)
        {
            <li><a href="javascript:void(0)" class="team-chat" data-team-id="@team.Id">@team.Name</a></li>
        }
    </ul>
}

<script>
    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    // Disable the send button until connection is established.
    document.getElementById("sendButton").disabled = true;

    connection.on("ReceiveMessage", function (user, message) {
        var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        var encodedMsg = user + ": " + msg;
        var li = document.createElement("li");
        li.textContent = encodedMsg;
        document.getElementById("messagesList").appendChild(li);
    });

    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
    }).catch(function (err) {
        console.error(err.toString());
    });

    document.getElementById("sendButton").addEventListener("click", function (event) {
        var message = document.getElementById("messageInput").value;
        connection.invoke("SendMessageToOrganization", "@User.Identity.Name", message, "@Model.OrganizationId").catch(function (err) {
            console.error(err.toString());
        });
        event.preventDefault();
    });

    document.querySelectorAll('.team-chat').forEach(item => {
        item.addEventListener('click', event => {
            // Handle team chat room switching
            var teamId = item.getAttribute("data-team-id");
            // Example invocation method to join the team chat room
            connection.invoke("JoinTeam", teamId).catch(function (err) {
                console.error(err.toString());
            });
        });
    });
</script>
